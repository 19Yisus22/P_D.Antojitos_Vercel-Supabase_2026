CREATE EXTENSION IF NOT EXISTS "pgcrypto";

DROP TABLE IF EXISTS facturas CASCADE;
DROP TABLE IF EXISTS comentarios CASCADE;
DROP TABLE IF EXISTS pedidos CASCADE;
DROP TABLE IF EXISTS pedido_detalle CASCADE; 
DROP TABLE IF EXISTS carrito CASCADE;
DROP TABLE IF EXISTS gestion_productos CASCADE;
DROP TABLE IF EXISTS usuarios CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS publicidad CASCADE;
DROP TABLE IF EXISTS metodos_pago CASCADE;

CREATE TABLE roles (
    id_role UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre_role TEXT UNIQUE NOT NULL CHECK (nombre_role IN ('admin','cliente','visitante')),
    descripcion TEXT
);

CREATE TABLE usuarios (
    id_cliente UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    imagen_url TEXT DEFAULT 'static/uploads/default_icon_profile.png',
    nombre TEXT NOT NULL,
    apellido TEXT NOT NULL,
    telefono TEXT,
    correo TEXT UNIQUE NOT NULL,
    contrasena TEXT,
    id_role UUID REFERENCES roles(id_role),
    direccion TEXT,
    cedula TEXT UNIQUE,
    metodo_pago TEXT CHECK (metodo_pago IN ('Efectivo','Transferencia')) DEFAULT 'Efectivo',
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ultima_conexion TIMESTAMP WITH TIME ZONE
);

CREATE TABLE gestion_productos (
    id_producto UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre TEXT NOT NULL,
    descripcion TEXT,
    precio NUMERIC(12,2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    imagen_url TEXT,
    categoria TEXT DEFAULT 'Postre',
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    estado BOOLEAN DEFAULT TRUE
);

CREATE TABLE carrito (
    id_carrito UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_cliente UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    id_producto UUID REFERENCES gestion_productos(id_producto) ON DELETE CASCADE,
    nombre_producto TEXT,
    cantidad INT NOT NULL CHECK (cantidad > 0),
    precio_unitario NUMERIC(12,2) NOT NULL,
    total NUMERIC(12,2),
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE pedidos (
    id_pedido UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_cliente UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    direccion_entrega TEXT NOT NULL,
    metodo_pago TEXT CHECK (metodo_pago IN ('Efectivo','Transferencia')),
    estado TEXT NOT NULL DEFAULT 'Pendiente' CHECK (estado IN ('Pendiente','Enviado','Entregado','Cancelado')),
    pagado BOOLEAN DEFAULT FALSE,
    fecha_pedido TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    total NUMERIC(12,2) DEFAULT 0,
    numero_factura TEXT UNIQUE
);

CREATE TABLE metodos_pago (
    id_pago UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entidad TEXT NOT NULL CHECK (entidad IN ('Nequi', 'Daviplata', 'Bancolombia', 'NuBank')),
    tipo_cuenta TEXT NOT NULL CHECK (tipo_cuenta IN ('Billetera Digital', 'Ahorros', 'Corriente')),
    numero TEXT NOT NULL,
    titular TEXT NOT NULL,
    qr_url TEXT,
    estado BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE facturas (
    id_factura UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_pedido UUID REFERENCES pedidos(id_pedido) ON DELETE CASCADE,
    id_cliente UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    id_pago UUID REFERENCES metodos_pago(id_pago) ON DELETE SET NULL,
    numero_factura SERIAL UNIQUE,
    fecha_emision TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    subtotal NUMERIC(12,2) NOT NULL,
    total NUMERIC(12,2) NOT NULL,
    metodo_pago TEXT CHECK (metodo_pago IN ('Efectivo','Transferencia')),
    estado TEXT DEFAULT 'Emitida' CHECK (estado IN ('Emitida', 'Anulada', 'Pagada')),
    cedula TEXT
);

CREATE TABLE pedido_detalle (
    id_detalle UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_pedido UUID REFERENCES pedidos(id_pedido) ON DELETE CASCADE,
    id_producto UUID REFERENCES gestion_productos(id_producto) ON DELETE RESTRICT,
    nombre_producto TEXT NOT NULL,
    cantidad INT NOT NULL CHECK (cantidad > 0),
    precio_unitario NUMERIC(12,2) NOT NULL CHECK (precio_unitario >= 0),
    subtotal NUMERIC(12,2)
);

CREATE TABLE comentarios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    id_usuario UUID REFERENCES usuarios(id_cliente) ON DELETE CASCADE,
    nombre_usuario TEXT NOT NULL,
    correo_usuario TEXT NOT NULL,
    foto_perfil TEXT,
    mensaje TEXT NOT NULL,
    likes_usuarios JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE publicidad (
    id_publicidad UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tipo TEXT NOT NULL CHECK (tipo IN ('carrusel', 'seccion', 'notificacion', 'cinta')),
    titulo TEXT,
    descripcion TEXT,
    imagen_url TEXT,
    estado BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE facturas 
ALTER COLUMN numero_factura TYPE TEXT;
ALTER TABLE pedidos 
ALTER COLUMN numero_factura TYPE TEXT;

CREATE OR REPLACE FUNCTION es_admin()
RETURNS BOOLEAN AS $$
BEGIN
    RETURN EXISTS (
        SELECT 1 FROM usuarios
        WHERE id_cliente = auth.uid()
        AND id_role = (SELECT id_role FROM roles WHERE nombre_role = 'admin' LIMIT 1)
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION calcular_total_carrito() 
RETURNS TRIGGER AS $$
BEGIN
    NEW.total := NEW.cantidad * NEW.precio_unitario;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION calcular_subtotal_detalle() 
RETURNS TRIGGER AS $$
BEGIN
    NEW.subtotal := NEW.cantidad * NEW.precio_unitario;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION actualizar_total_pedido() 
RETURNS TRIGGER AS $$
BEGIN
    UPDATE pedidos 
    SET total = (SELECT COALESCE(SUM(subtotal), 0) FROM pedido_detalle WHERE id_pedido = COALESCE(NEW.id_pedido, OLD.id_pedido))
    WHERE id_pedido = COALESCE(NEW.id_pedido, OLD.id_pedido);
    RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION gestionar_stock_pedido() 
RETURNS TRIGGER AS $$
DECLARE
    item RECORD;
BEGIN
    IF (TG_OP = 'UPDATE' AND OLD.estado = 'Pendiente' AND NEW.estado IN ('Enviado', 'Entregado')) THEN
        FOR item IN SELECT id_producto, cantidad FROM pedido_detalle WHERE id_pedido = NEW.id_pedido LOOP
            UPDATE gestion_productos SET stock = stock - item.cantidad WHERE id_producto = item.id_producto;
        END LOOP;
    ELSIF (TG_OP = 'UPDATE' AND OLD.estado IN ('Enviado', 'Entregado') AND NEW.estado = 'Cancelado') THEN
        FOR item IN SELECT id_producto, cantidad FROM pedido_detalle WHERE id_pedido = NEW.id_pedido LOOP
            UPDATE gestion_productos SET stock = stock + item.cantidad WHERE id_producto = item.id_producto;
        END LOOP;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION actualizar_ultima_conexion()
RETURNS TRIGGER AS $$
BEGIN
    NEW.ultima_conexion = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE FUNCTION asignar_rol_cliente()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id_role IS NULL THEN
        NEW.id_role := (SELECT id_role FROM roles WHERE nombre_role='cliente' LIMIT 1);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE TRIGGER trg_calc_carrito BEFORE INSERT OR UPDATE ON carrito FOR EACH ROW EXECUTE FUNCTION calcular_total_carrito();
CREATE TRIGGER trg_calc_detalle BEFORE INSERT OR UPDATE ON pedido_detalle FOR EACH ROW EXECUTE FUNCTION calcular_subtotal_detalle();
CREATE TRIGGER trg_actualizar_total_pedido AFTER INSERT OR UPDATE OR DELETE ON pedido_detalle FOR EACH ROW EXECUTE FUNCTION actualizar_total_pedido();
CREATE TRIGGER trg_stock_pedido AFTER UPDATE ON pedidos FOR EACH ROW EXECUTE FUNCTION gestionar_stock_pedido();
CREATE TRIGGER trg_actualizar_conexion BEFORE UPDATE ON usuarios FOR EACH ROW EXECUTE FUNCTION actualizar_ultima_conexion();
CREATE TRIGGER trg_asignar_rol_cliente BEFORE INSERT ON usuarios FOR EACH ROW EXECUTE FUNCTION asignar_rol_cliente();

ALTER TABLE roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE usuarios ENABLE ROW LEVEL SECURITY;
ALTER TABLE gestion_productos ENABLE ROW LEVEL SECURITY;
ALTER TABLE carrito ENABLE ROW LEVEL SECURITY;
ALTER TABLE pedidos ENABLE ROW LEVEL SECURITY;
ALTER TABLE facturas ENABLE ROW LEVEL SECURITY;
ALTER TABLE pedido_detalle ENABLE ROW LEVEL SECURITY;
ALTER TABLE comentarios ENABLE ROW LEVEL SECURITY;
ALTER TABLE publicidad ENABLE ROW LEVEL SECURITY;
ALTER TABLE metodos_pago ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Permitir todo a service_role" ON usuarios FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_roles" ON roles FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_productos" ON gestion_productos FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_carrito" ON carrito FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_pedidos" ON pedidos FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_facturas" ON facturas FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_detalle" ON pedido_detalle FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_comentarios" ON comentarios FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_publicidad" ON publicidad FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Permitir todo a service_role_metodos" ON metodos_pago FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY "Lectura pública perfiles" ON usuarios FOR SELECT USING (true);
CREATE POLICY "Ver productos" ON gestion_productos FOR SELECT USING (true);
CREATE POLICY "Cliente CRUD limitado carrito" ON carrito FOR ALL USING (id_cliente = auth.uid());
CREATE POLICY "Cliente ver pedidos" ON pedidos FOR SELECT USING (id_cliente = auth.uid());
CREATE POLICY "Publico ver publicidad activa" ON publicidad FOR SELECT USING (estado = true);
CREATE POLICY "Lectura pública metodos" ON metodos_pago FOR SELECT USING (estado = true);
CREATE POLICY "Admin total" ON usuarios FOR ALL USING (es_admin());

INSERT INTO roles (nombre_role, descripcion) VALUES 
('cliente', 'Acceso estándar'),
('admin', 'Administrador total'),
('visitante', 'Solo lectura')
ON CONFLICT (nombre_role) DO NOTHING;